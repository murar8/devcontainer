name: release

on:
  push:
    branches: ["main"]
    tags: ["v*"]

env:
  DOCKERHUB_USERNAME: murar8
  SCRIPTS_RELEASE: v0.146.0

jobs:
  release:
    runs-on: ubuntu-latest

    strategy:
      max-parallel: 1
      matrix:
        ubuntu-version: ["bionic", "focal", "groovy"]

    steps:
      - uses: actions/checkout@v2

      - uses: docker/setup-buildx-action@v1

      # - uses: actions/cache@v2
      #   with:
      #     path: /tmp/.buildx-cache
      #     key: ${{ runner.os }}-buildx-${{ github.sha }}
      #     restore-keys: ${{ runner.os }}-buildx-

      - uses: docker/login-action@v1
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - run: echo ::set-output name=tag::${GITHUB_REF#refs/*/}
        id: tag-name

      - uses: docker/build-push-action@v2
        with:
          push: true
          cache-from: type=registry,ref=murar8/devcontainer-base:${{ matrix.ubuntu-version }}-latest
          cache-to: type=inline
          build-args: |
            SCRIPTS_RELEASE=${{ env.SCRIPTS_RELEASE }}
            UBUNTU_VERSION=${{ matrix.ubuntu-version }}
          tags: |
            murar8/devcontainer-base:${{ matrix.ubuntu-version }}-latest
            murar8/devcontainer-base:${{ matrix.ubuntu-version }}-${{ steps.tag-name.outputs.tag }}
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.clone_url }}
            org.opencontainers.image.revision=${{ github.sha }}

  update-description:
    runs-on: ubuntu-latest

    needs: release

    if: github.ref == 'refs/heads/main'

    steps:
      - uses: peter-evans/dockerhub-description@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          repository: murar8/devcontainer-base
